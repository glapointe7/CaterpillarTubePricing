---
output: pdf_document
---
# General Observations on Train Set

The first objective is to find all features on which the cost depends from the train set. Then, we find which machine learning algorithms will apply depending of these features.

Let's define the features used in the training set. The description is given in the codebook.

| Feature        | Variable |
|----------------|---------|
| $x_1$          | tube_assembly_id |
| $x_2$          | supplier |
| $x_3$          | quote_date |
| $x_4$          | annual_usage |
| $x_5$          | min_order_quantity |
| $x_6$          | bracket_pricing |
| $x_7$          | quantity |
| $x_8$          | cost |

Let's denote $h_{\beta}(x)$ our cost heuristic function of a tube assembly given by a supplier where $\beta$ is our learning parameters. Since the output of this analysis is known (the cost a supplier will quote for a given tube assembly), then we will use a supervised algorithm.

Per the codebook, $x_6$ determines on which features the cost depends. We will use 2 classes to base our cost estimation.

1. Bracket pricing ($x_6 = 1$ (Yes)) where the function $C(x)$ depends of $x_7$ amoung other features.
2. Non-bracket pricing ($x_6 = 0$ (No)) where the function $C(x)$ depends of $x_5$ and $x_7$. 

As a supplier, we have to think on which features (properties) of the tube the cost will be based. We know that a tube assembly is made with one or more components. Some properties may be helpful to check:

* The weight of the tube
* The quantity of tubes
* The volume of the tube
* The material properties used to make the tube which can be used to get the density
* The number of bends used. Logically, it is more difficult to bend a tube than to keep it linear, so it should be more expansive.

Other factors than the tube properties may also be helpful to check.

* The date when the supplier has quoted the price which is certainly less 20 years ago than today when not adjusted.
* The supplier may use different mathematical models to quote his price. We can then classify the data by supplier.
* The tube assembly ID may be used at some points in the prediction. Need to investigate why specifically these tubes are chosen in the train set.
* The costs have too many decimals to be a real cost. Maybe a conversion is needed in some way to get the real cost.
* The supplier may have decided to quote the tubes with very expensive or cheap price. These prices can be considered as anomalies.

From the dataset, we note that there are a total of 2048 components. These components are spread amoung the `comp_[type].csv` files uniquely. This means that we can create a single table `Component` by merging those files together with the `merge` function. To avoid to many columns, we will remove some features that we will not want in our analysis.

## Simple Test on Comparing Quantities and Costs

In this section, we simplify the dataset where we use the bracket pricing with the supplier S-0066. The objective is to find a mathematical model representing the cost in function of the quantity.

We start with the 3 first tube assemblies (TA-00002, TA-00004 and TA-00005) which have the bracket pricing and supplier S-0066.

```{r echo = FALSE, message = FALSE, warning = FALSE}
source("Scripts/DatabaseManipulation.R")

library(ggplot2)
library(knitr)

database <- CaterpillarDatabase$new()
database$connect()

query <- "SELECT fkTubeAssembly, supplierID, quantity, cost
          FROM TubeAssemblyPricing
          WHERE fkTubeAssembly IN (2, 4, 5)
          ORDER BY fkTubeAssembly, quantity;"

data <- database$selectFromTable(query)
kable(data, format = "markdown", caption = "Table built from Tube 2 and 4")

plot(data$quantity, data$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = c(0, 100), ylim = c(0, 22))
curve((18.9/x) + 3, xlim = c(1, 100), ylim = c(0, 22), add = TRUE, col = "blue")
curve((23.477796/x) + 4.896424, xlim = c(1, 100), ylim = c(0, 22), add = TRUE, col = "green")
title("Cost of tubes 2,3,5 in function of the quantity by Supplier S-0066")
legend('topright', c("Data from Table 1", "y = (18.9/x) + 3", "y = (23.477796/x) + 4.896424"), lty = 1, col = c('red', 'blue', 'green'), bty = 'o', cex = .75)
```

From the plot, we see that the curve representing the points is clearly an hyperbola of equation 
$$h_{\beta}(x_7) = \frac{\beta_0}{x_7} + \beta_1$$
where $x_7 \geq 1$, $\beta_1$ is the cost at the last level of purchase based on quantity and $\beta_0 = h_{\beta}(1) - \beta_1$. This equation indicates that if Caterpillar buy more tubes, cheaper will be the cost per tube by the supplier `S-0066`.

We need to find on which features depend $\beta_0$ and $\beta_1$. 

### Physical Properties of Tubes

The goal of this section is to get the total weight for each tube assembly and check if the cost depends of the weight. If yes, then we have to modelize this dependency to help our estimation of the cost.

The file `bill_of_materials.csv` gives us the list of components with their respective quantity used to assemble a tube. Thus, to calculate the total weight for each tube, we use the formula $$W_T = \sum_{i = 0}^n W_i * Q_i$$ where $W_T$ is the total weight of the tube $T$, $W = (W_1,\ldots,W_n)$ is the vector of component weights, $Q = (Q_1,\ldots,Q_n)$ the vector of component quantities and $n \leq 8$ the number of possible components used to assemble a tube $T$.

Let the total volume estimation of a tube assembly be denoted by $V_T$. The volume is function of the length, the wall thickness and the diameter of the tube and its formula is $$V_T = \pi L t(d - t)$$, where $t$ is the wall thickness, $d$ the outside diameter and $L$ the developed length of the tube.

```{r echo = FALSE, message = FALSE, warning = FALSE}
query <- "SELECT TAP.fkTubeAssembly AS TubeAssemblyID, TAP.supplierID, TAC.totalWeight, 
        	     PI() * TA.length * TA.wallThickness * (TA.diameter - TA.wallThickness) AS volume,
        	     TA.numberOfBends, TAP.quantity, TAP.cost
          FROM TubeAssemblyPricing AS TAP
        	  INNER JOIN 
        	  (
        		  SELECT fkTubeAssembly, SUM(C.weight * TAC.quantity) AS totalWeight
        		  FROM Component AS C
        			  INNER JOIN TubeAssembly_Component AS TAC ON C.pkComponent = TAC.fkComponent
        		  GROUP BY TAC.fkTubeAssembly
        	  ) AS TAC ON TAC.fkTubeAssembly = TAP.fkTubeAssembly
        	  INNER JOIN TubeAssembly AS TA ON TA.pkTubeAssembly = TAP.fkTubeAssembly
          WHERE TAP.fkTubeAssembly < 15
          ORDER BY TAP.fkTubeAssembly, TAP.quantity;"

data <- database$selectFromTable(query)
kable(data, format = "markdown", caption = "Table 2")

gc()
```
