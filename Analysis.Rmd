---
output: pdf_document
---
# 1 Pre-analysis & Questions
The first objective is to observe what features may influence the cost of tubes. We start our observation with the features given in the training set where we define a variable for each feature.

| Variable       | Feature |
|----------------|---------|
| $x_1$          | tube_assembly_id |
| $x_2$          | supplier |
| $x_3$          | quote_date |
| $x_4$          | annual_usage |
| $x_5$          | min_order_quantity |
| $x_6$          | bracket_pricing |
| $x_7$          | quantity |
| $x_8$          | cost |


### 1.1  Tube Physical Properties
As a supplier, we have to think on which tube features the cost will be based. We know that a tube assembly is made with one or more components. Some numerical tube properties may be helpful to check.

* The weight
* The quantity
* The volume
* The number of bends used with the bend radius. Logically, it is more difficult to bend a tube than to keep it linear, so it should be more expansive.
* The component types used to assemble the tube.

### 1.2  Supplier Features

* The date when the supplier has quoted the price which is certainly less 20 years ago than today when not adjusted.
* The suppliers may use different mathematical models to quote their price.
* The supplier uses or not a bracket pricing which can influence what features to use in both cases.

### 1.3 Other Observations

* The tube assembly ID may be used at some points in the prediction. We need to investigate why and how these tubes are chosen in the train set.
* The costs have too many decimals to be a real cost. Maybe a conversion is needed in some way to get the real cost.
* The supplier may have decided to quote the tubes with very expensive or cheap price. These prices can be considered as anomalies.

### 1.4  Questions to Answer

To archieve our goal of predicting the cost with a good accuracy, we need to answer the following questions.

1. What features are used to determine the cost and what features to exclude from the analysis?
2. Do the costs presented in the training set are the real costs or do they need to be adjusted?
3. Is there a unique mathematical model describing the cost in function of the quantity for each supplier?
4. What particular features need to be classified? Why? How?
5. Are there anomalies to consider in the dataset? Why? 


# 2    Preparing & Cleaning the Dataset
In this section, we will answer the first question: _What features are used to determine the cost and what features to exclude from the analysis?_ We will also explain why we chose to keep and exclude features and how we will clean the dataset.

From the dataset, we note that there are a total of 2048 components. These components are spread amoung the `comp_[type].csv` files uniquely. This means that we can create a single table `Component` by merging those files together. To avoid to many columns, we will remove some features that we do not want in our analysis.

The file `bill_of_materials.csv` gives us the list of components with their respective quantity used to assemble a tube. Thus, to calculate the total weight for each tube, we use the formula $$W_T = \sum_{i = 0}^n W_i * Q_i$$ where $W_T$ is the total weight of the tube $T$, $W = (W_1,\ldots,W_n)$ is the vector of component weights, $Q = (Q_1,\ldots,Q_n)$ the vector of component quantities and $n \leq 8$ the number of possible components used to assemble a tube $T$.

Let the total volume estimation of a tube assembly be denoted by $V_T$. The volume is function of the length, the wall thickness and the diameter of the tube and its formula is $$V_T = \pi L t(d - t)$$, where $t$ is the wall thickness, $d$ the outside diameter and $L$ the developed length of the tube.

We use the Chi-Squared test to check if a feature is independent or dependent of the cost. We reject the hypothesis of independence if the p-value is greater than 0.05.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
source("Scripts/DatabaseManipulation.R")

## Include libraries for plotting graphes and to display some tables.
library(ggplot2)
library(xtable)
library(knitr)

database <- CaterpillarDatabase$new()
database$connect()

query <- "SELECT TAP.fkTubeAssembly AS tubeAssemblyID, TAC.totalWeight, 
        	     PI() * TA.length * TA.wallThickness * (TA.diameter - TA.wallThickness) AS volume,
        	     TA.numberOfBends, COUNT(TAP.quantity) AS cntQty, TAP.cost
          FROM TubeAssemblyPricing AS TAP
        	  INNER JOIN TubeAssemblyWeightView AS TAC ON TAC.fkTubeAssembly = TAP.fkTubeAssembly
        	  INNER JOIN TubeAssembly AS TA ON TA.pkTubeAssembly = TAP.fkTubeAssembly
          WHERE TAC.totalWeight IS NOT NULL
          GROUP BY TAP.fkTubeAssembly;"

data <- database$selectFromTable(query)
print(xtable(head(data, 10), caption = ''), comment = FALSE, type = 'latex')

## Test if the cost depends of the total weight.
tbl <- table(data$totalWeight, data$cost)
chisq.test(tbl)
plot(data$totalWeight, data$cost, col = "red", xlab = "Weight", ylab = "Cost", xlim = c(0, 15), ylim = c(0, 1000))
```

Following the Chi-Square test done and the plot, the cost is independent of the weight of a tube since the p-value is less than 0.05.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
## Test if the cost depends of the volume.
tbl <- table(data$volume, data$cost)
chisq.test(tbl)
plot(data$volume, data$cost, col = "red", xlab = "volume", ylab = "Cost", xlim = c(0, 100000), ylim = c(0, 1000))
```

Following the Chi-Square test done and the plot, the cost is independent of the volume of a tube since the p-value is less than 0.05.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
## Test if the cost depends of the number Of Bends
tbl <- table(data$numberOfBends, data$cost)
chisq.test(tbl)
```

Following the Chi-Square tests done, the cost is dependent of the number of bends since the p-value is greater than 0.05.


# 3 Real Cost vs Adjusted Cost
In this section, we will answer the question: _Do the costs presented in the training set are the real costs or do they need to be adjusted?_

# 4 Supplier's Model
In this section, we will answer the question: _Is there a unique mathematical model describing the cost in function of the quantity for each supplier?_ The first objective is to check the existence of a mathematical model representing the cost in function of the quantity. The second objective is to show if the model is applied by a unique supplier. The last objective is to show if each supplier has its own model. If the unicity does not hold, then we have to check if a model is applied by more than one supplier or if a supplier can apply more than one model depending of other features.

We denote $C_{\beta}(Q)$ our cost heuristic function of a tube assembly given by a supplier where $\beta$ is our learning parameters and $Q$ the vector of quantities.

### 4.1 Existence of a Mathematical Model
We start with the few tube assemblies which are quoted by the supplier `S-0066`.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT fkTubeAssembly, supplierID, quantity, cost
          FROM TubeAssemblyPricing
          WHERE fkTubeAssembly IN (2, 5, 5000, 19365)
          ORDER BY fkTubeAssembly, quantity;"

data <- database$selectFromTable(query)
print(xtable(data, caption = "Table built from Tube 2, 5, 5000, 19365"), comment = FALSE, type = 'latex')

par(mfrow = c(1,3), xpd = TRUE)
data_min <- data[data$fkTubeAssembly == c(2, 5),]
plot(data_min$quantity, data_min$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = c(1, 100), ylim = range(data_min$cost))
points(data_min$quantity, data_min$cost, pch = 20, col = "red")
mtext("Cost of tubes in function of quantity (Supplier S-0066)", side = 3, line = -1, outer = TRUE)

curve((18.906873355/x) + 2.999059664, add = TRUE, col = "blue")
curve((23.477796387/x) + 4.8964239413, add = TRUE, col = "green")

data_max <- data[data$fkTubeAssembly == 5000,]
plot(data_max$quantity, data_max$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = range(data_min$quantity), ylim = range(data_max$cost))
points(data_max$quantity, data_max$cost, pch = 15, col = "red")
curve((20.153235813/x) + 121.5064293385, col = "black", add = TRUE)

data_large <- data[data$fkTubeAssembly == 19365,]
plot(data_large$quantity, data_large$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = range(data_min$quantity), ylim = range(data_large$cost))
points(data_large$quantity, data_large$cost, pch = 15, col = "red")
curve((244.434490855/x) + 54.3475236892, add = TRUE, col = "chocolate")

# legend(
#     'topright', 
#     c("Dataset Pts", "Tube 2", "Tube 5", "Tube 8459", "Tube 5000"), 
#     lty = 1, 
#     col = c('red', 'blue', 'green', 'yellow', 'black'), 
#     bty = 'n', 
#     cex = .75,
#     inset = c(-0.2, -0.35)
# )
```

From the graphs, we see that the curves estimating the red points are clearly hyperbolas of equation 
$$C_{\beta}(Q) = \frac{\beta_0 - \beta_1}{Q} + \beta_1$$
where $Q \geq 1$ is the quantity, $\beta_1$ is the cost at the last level of purchase based on quantity and supplier (most of the time $Q = 250$), and $\beta_0$ is the cost at the first level of purchase based on quantity and supplier (most of the time $Q = 1$). This equation indicates that if Caterpillar buy more tubes, cheaper will be the cost per tube. This proves the existence of a mathematical model representing the cost in function of the quantity.

If we take a look at the right most graph, we see that our curve doesn't seem to fit the points. However, the maximum quantity is 7 (not 250) for this tube which make the model less accurate assuming the same model is used. This assumption make sense since 
$$\lim_{Q \to \infty} C_{\beta}(Q) = \beta_1$$
which means that we need to find the right $\beta_1$ to match with any quantity. We also have to find the cost of one tube which is $\beta_0$.

We start by analyzing on what features $\beta_0$ depends.
```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT TAP.fkTubeAssembly, TAP.supplierID, TA.numberOfBends, TAP.cost
          FROM TubeAssemblyPricing AS TAP
        	  INNER JOIN TubeAssembly AS TA ON TA.pkTubeAssembly = TAP.fkTubeAssembly
          WHERE TAP.quantity = 1;"

data <- database$selectFromTable(query)
print(xtable(head(data, 8), caption = "Table built where quantity is 1"), comment = FALSE, type = 'latex')

par(mfrow = c(1,2), xpd = TRUE)
plot(data$numberOfBends, data$cost, col = "red", xlab = "#Bends", ylab = "Cost", xlim = range(data$numberOfBends), ylim = range(data$cost))
points(data$numberOfBends, data$cost, pch = 20, col = "red")
mtext("Cost of tubes in function of the #bends where tube's quantity is 1", side = 3, line = -1, outer = TRUE)
```


### 4.2 Unicity of the Model per Supplier
We verify with few tube assemblies which are quoted by the supplier `S-0054` if the same model used for the supplier `S-0066` applies.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT fkTubeAssembly, supplierID, quantity, cost
          FROM TubeAssemblyPricing
          WHERE fkTubeAssembly IN (130, 280, 1892, 5013)
          ORDER BY fkTubeAssembly, quantity;"

data <- database$selectFromTable(query)
print(xtable(data, caption = "Table built from Tube 130, 280, 1892, 5013"), comment = FALSE, type = 'latex')

plot(data$quantity, data$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = range(data$quantity), ylim = range(data$cost))
points(data$quantity, data$cost, pch = 20, col = "red")
mtext("Cost of tubes in function of quantity (Supplier S-0054)", side = 3, line = -1, outer = TRUE)

curve((9.528552272/x) + 4.6265642127, add = TRUE, col = "blue")
curve((12.076918369/x) + 17.304407338, add = TRUE, col = "green")
curve((4.273242712/x) + 3.8531517947, add = TRUE, col = "black")
curve((4.092408874/x) + 3.043572609, add = TRUE, col = "chocolate")
```

The model used by the supplier `S-0054` seems to be the same as the one used by the supplier `S-0066`, but if we look carefully the curves, we see that greater is the quantity, more accurate is the estimate. This means that the model follows the same behaviour as both as the model used by the supplier `S-0066`. This shows that a model can be used by more than one supplier.

# 5    Classified Features

# 6    Anomalies Detection
<!--
```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT fkTubeAssembly, supplierID, MIN(quantity) AS minQty, COUNT(quantity) AS purchaseLevel, cost
          FROM TubeAssemblyPricing
          GROUP By fkTubeAssembly
          HAVING purchaseLevel = 8
          ORDER BY cost;"

data <- database$selectFromTable(query)
kable(head(data, 8), format = "markdown", caption = "Minimum Cost")
kable(tail(data, 8), format = "markdown", caption = "Maximum Cost")

gc()
```
-->
