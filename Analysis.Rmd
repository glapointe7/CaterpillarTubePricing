---
output: pdf_document
---
# 1 Pre-analysis & Questions
The first objective is to observe what features may influence the cost of tubes. We start our observation with the features given in the training set where we define a variable for each feature.

| Variable       | Feature |
|----------------|---------|
| $x_1$          | tube_assembly_id |
| $x_2$          | supplier |
| $x_3$          | quote_date |
| $x_4$          | annual_usage |
| $x_5$          | min_order_quantity |
| $x_6$          | bracket_pricing |
| $x_7$          | quantity |
| $x_8$          | cost |

Since we are predicting the cost value, a continuous variable, we will use a regression algorithm.

### 1.1  Tube Physical Properties
As a supplier, we have to think on which tube features the cost will be based. We know that a tube assembly is made with one or more components. Some numerical tube properties may be helpful to check.

* The weight
* The quantity
* The volume
* The number of bends used with the bend radius. Logically, it is more difficult to bend a tube than to keep it linear, so it should be more expansive.
* The component types used to assemble the tube.
* The number of components to assemble a tube.

### 1.2  Supplier Features

* The date when the supplier has quoted the price which is certainly less 20 years ago than today when not adjusted.
* The suppliers may use different mathematical models to quote their price.
* The supplier uses or not a bracket pricing which can influence what features to use in both cases.

### 1.3 Other Observations

* The tube assembly ID may be used at some points in the prediction. We need to investigate why and how these tubes are chosen in the train set.
* The costs have too many decimals to be a real cost. Maybe a conversion is needed in some way to get the real cost.
* The supplier may have decided to quote the tubes with very expensive or cheap price. These prices can be considered as anomalies.

### 1.4  Questions to Answer

To archieve our goal of predicting the cost with a good accuracy, we need to answer the following questions.

1. What features are used to determine the cost and what features to exclude from the analysis?
2. Is there a unique mathematical model describing the cost in function of the quantity for each supplier?
3. If a mathematical model exists, is it a linear or non-linear model? 
4. Are there decisions to take? If yes, what decisions?


# 2 Preparing & Cleaning the Dataset
In this section, we will answer the question: _What features are used to determine the cost and what features to exclude from the analysis?_ We will also explain why we chose to keep and exclude features and how we will clean the dataset.

From the dataset, we note that there are a total of 2048 components. These components are spread amoung the `comp_[type].csv` files uniquely. This means that we can create a single table `Component` by merging those files together. To avoid to many columns, we will remove some features that we do not want in our analysis.

The file `bill_of_materials.csv` gives us the list of components with their respective quantity used to assemble a tube. Thus, to calculate the total weight for each tube, we use the formula $$W_T = \sum_{i = 0}^n W_i * Q_i$$ where $W_T$ is the total weight of the tube $T$, $W = (W_1,\ldots,W_n)$ is the vector of component weights, $Q = (Q_1,\ldots,Q_n)$ the vector of component quantities and $n \leq 8$ the number of possible components used to assemble a tube $T$.

Let the total volume estimation of a tube assembly be denoted by $V_T$. The volume is function of the length, the wall thickness and the diameter of the tube and its formula is $$V_T = \pi L t(d - t)$$, where $t$ is the wall thickness, $d$ the outside diameter and $L$ the developed length of the tube.

We use the Chi-Squared test to check if a feature is independent or dependent of the cost. We reject the hypothesis of independence if the p-value is greater than 0.05.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
source("Scripts/DatabaseManipulation.R")

## Include libraries for plotting graphes and to display some tables.
library(ggplot2)
library(xtable)
library(knitr)
library(randomForest)

database <- CaterpillarDatabase$new()
database$connect()

query <- "SELECT TAP.fkTubeAssembly AS tubeAssemblyID, TAC.totalWeight, 
        	     PI() * TA.length * TA.wallThickness * (TA.diameter - TA.wallThickness) AS volume,
        	     TA.numberOfBends, COUNT(TAP.quantity) AS cntQty, TAP.cost
          FROM TubeAssemblyPricing AS TAP
        	  INNER JOIN TubeAssemblyWeightView AS TAC ON TAC.fkTubeAssembly = TAP.fkTubeAssembly
        	  INNER JOIN TubeAssembly AS TA ON TA.pkTubeAssembly = TAP.fkTubeAssembly
          WHERE TAC.totalWeight IS NOT NULL
          GROUP BY TAP.fkTubeAssembly;"

data <- database$selectFromTable(query)
print(xtable(head(data, 10), caption = ''), comment = FALSE, type = 'latex')

## Test if the cost depends of the total weight.
tbl <- table(data$totalWeight, data$cost)
chisq.test(tbl)
plot(data$totalWeight, data$cost, col = "red", xlab = "Weight", ylab = "Cost", xlim = c(0, 15), ylim = c(0, 1000))
```

Following the Chi-Square test done and the plot, the cost is independent of the weight of a tube since the p-value is less than 0.05.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
## Test if the cost depends of the volume.
tbl <- table(data$volume, data$cost)
chisq.test(tbl)
plot(data$volume, data$cost, col = "red", xlab = "volume", ylab = "Cost", xlim = c(0, 100000), ylim = c(0, 1000))
```

Following the Chi-Square test done and the plot, the cost is independent of the volume of a tube since the p-value is less than 0.05.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
## Test if the cost depends of the number Of Bends
tbl <- table(data$numberOfBends, data$cost)
chisq.test(tbl)
```

Following the Chi-Square tests done, the cost is dependent of the number of bends since the p-value is greater than 0.05.


# 3 Mathematical Models
In this section, we will answer the question: _Is there a unique mathematical model describing the cost in function of the quantity for each supplier?_ The first objective is to check the existence of a mathematical model representing the cost in function of the quantity. The second objective is to show if the model is applied by a unique supplier. The last objective is to show if each supplier has its own model. If the unicity does not hold, then we have to check if a model is applied by more than one supplier or if a supplier can apply more than one model depending of other features. We will then answer the question: _If a mathematical model exists, is it a linear or non-linear model?_

We denote $C_{\beta}(Q)$ our cost heuristic function of a tube assembly given by a supplier where $\beta$ is our learning parameters and $Q$ the vector of quantities.

### 3.1 Existence of a Mathematical Model
We start with the few tube assemblies which are quoted by the supplier `S-0066`.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT fkTubeAssembly, supplierID, quantity, cost
          FROM TubeAssemblyPricing
          WHERE fkTubeAssembly IN (2, 5, 5000, 19365)
          ORDER BY fkTubeAssembly, quantity;"

data <- database$selectFromTable(query)
print(xtable(data, caption = "Table built from tubes 2, 5, 5000, 19365"), comment = FALSE, type = 'latex')

par(mfrow = c(1,3), xpd = TRUE)
data_min <- data[data$fkTubeAssembly == c(2, 5),]
plot(data_min$quantity, data_min$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = c(1, 100), ylim = range(data_min$cost))
points(data_min$quantity, data_min$cost, pch = 20, col = "red")
mtext("Cost of tubes in function of quantity (Supplier S-0066)", side = 3, line = -1, outer = TRUE)

curve((18.906873355/x) + 2.999059664, add = TRUE, col = "blue")
curve((23.477796387/x) + 4.8964239413, add = TRUE, col = "green")

data_max <- data[data$fkTubeAssembly == 5000,]
plot(data_max$quantity, data_max$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = range(data_min$quantity), ylim = range(data_max$cost))
points(data_max$quantity, data_max$cost, pch = 15, col = "red")
curve((20.153235813/x) + 121.5064293385, col = "black", add = TRUE)

data_large <- data[data$fkTubeAssembly == 19365,]
plot(data_large$quantity, data_large$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = range(data_min$quantity), ylim = range(data_large$cost))
points(data_large$quantity, data_large$cost, pch = 15, col = "red")
curve((244.434490855/x) + 54.3475236892, add = TRUE, col = "chocolate")

# legend(
#     'topright', 
#     c("Dataset Pts", "Tube 2", "Tube 5", "Tube 8459", "Tube 5000"), 
#     lty = 1, 
#     col = c('red', 'blue', 'green', 'yellow', 'black'), 
#     bty = 'n', 
#     cex = .75,
#     inset = c(-0.2, -0.35)
# )
```

From the graphs, we see that the curves estimating the red points are clearly hyperbolas of equation 
$$C_{T}(Q) = \frac{\beta_0 - \beta_1}{Q} + \beta_1$$
where $Q \geq 1$ is the quantity for a tube assembly ID $T$, $\beta_1$ is the cost at the last level of purchase based on quantity and supplier (most of the time $Q = 250$), and $\beta_0$ is the cost at the first level of purchase based on quantity and supplier (most of the time $Q = 1$). This equation indicates that if Caterpillar buy more tubes, cheaper will be the cost per tube. This proves the existence of a mathematical model representing the cost in function of the quantity.

If we take a look at the right most graph, we see that our curve doesn't seem to fit the points. However, the maximum quantity is 7 (not 250) for this tube which make the model less accurate assuming the same model is used. This assumption makes sense since 
$$\lim_{Q \to \infty} C_{T}(Q) = \beta_1$$
which means that we need to find the right $\beta_1$ to match with any quantity. We also have to find the cost of one tube which is $\beta_0$.

For example, if we take the tube `TA-19365`, we have $C_{T}(1) = \beta_0 = 298.7820145446$. We know that $C_{T}(2) = \frac{\beta_0 + \beta_1}{2} = 156.1959237271 \Leftrightarrow \beta_1 = 13.60983291$. Therefore, the model for the tube `TA-19365` is $C_{T}(Q) = \frac{285.172181635}{Q} + 13.60983291$. With $Q = 7$, we obtain $C_{T}(7) = 54.348716001$ which has a square error of $0.000001422$ from the original cost. With our estimated, i.e. $C_{T}(Q) = (244.434490855/Q) + 54.3475236892$, we have $C_{T}(7) = 89.266736668$ which has a square error of $1219.351435073$. Thus, if $Q$ is small (say $Q < 25$), the model may underfit.

<!--
We start by analyzing on what features $\beta_0$ depends.
```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT TAP.fkTubeAssembly, TAP.supplierID, TA.numberOfBends, TAP.cost
          FROM TubeAssemblyPricing AS TAP
        	  INNER JOIN TubeAssembly AS TA ON TA.pkTubeAssembly = TAP.fkTubeAssembly
          WHERE TAP.quantity = 1;"

data <- database$selectFromTable(query)
print(xtable(head(data, 8), caption = "First tubes where quantity is 1"), comment = FALSE, type = 'latex')

#par(mfrow = c(1,2), xpd = TRUE)
plot(data$numberOfBends, data$cost, col = "red", xlab = "#Bends", ylab = "Cost", xlim = range(data$numberOfBends), ylim = range(data$cost))
points(data$numberOfBends, data$cost, pch = 20, col = "red")
mtext("Cost of tubes in function of the #bends where tube's quantity is 1", side = 3, line = -1, outer = TRUE)
```
-->


### 3.2 Unicity of the Model per Supplier
We verify with few tube assemblies which are quoted by the supplier `S-0054` if the same model used for the supplier `S-0066` applies.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT fkTubeAssembly, supplierID, quantity, cost
          FROM TubeAssemblyPricing
          WHERE fkTubeAssembly IN (130, 280, 1892, 5013)
          ORDER BY fkTubeAssembly, quantity;"

data <- database$selectFromTable(query)
print(xtable(data, caption = "Table built from Tube 130, 280, 1892, 5013"), comment = FALSE, type = 'latex')

plot(data$quantity, data$cost, col = "red", xlab = "Quantity", ylab = "Cost", xlim = range(data$quantity), ylim = range(data$cost))
points(data$quantity, data$cost, pch = 20, col = "red")
mtext("Cost of tubes in function of quantity (Supplier S-0054)", side = 3, line = -1, outer = TRUE)

curve((9.528552272/x) + 4.6265642127, add = TRUE, col = "blue")
curve((12.076918369/x) + 17.304407338, add = TRUE, col = "green")
curve((4.273242712/x) + 3.8531517947, add = TRUE, col = "black")
curve((4.092408874/x) + 3.043572609, add = TRUE, col = "chocolate")
```

The model used by the supplier `S-0054` seems to be the same as the one used by the supplier `S-0066`, but if we look carefully the curves, we see that greater is the quantity, more accurate is the estimate. This means that the model follows the same behaviour as the model used by the supplier `S-0066`.

This doesn't seem to be the case for the tube `TA-00384` from the supplier `S-0064`. This supplier provides 6 levels of purchase where the highest quantity is $Q = 45$. We use the same model as before but this time, the model doesn't fit the points.

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
query <- "SELECT fkTubeAssembly, supplierID, minOrderQuantity, anualUsage, quantity, cost
          FROM TubeAssemblyPricing
          WHERE fkTubeAssembly = 384;"

data <- database$selectFromTable(query)
print(xtable(data, caption = "Tube 384"), comment = FALSE, type = 'latex')

plot(data$quantity, data$minOrderQuantity, col = "red", xlab = "Quantity", ylab = "Cost", 
     xlim = range(data$quantity), ylim = range(data$cost))
points(data$quantity, data$cost, pch = 20, col = "red")
mtext("Cost in function of quantity for tube 384 of supplier S-0064", side = 3, line = -1, outer = TRUE)
curve((0.88469478 / (x-19)) + 4.401217429, add = TRUE, col = "blue")
gc()
```

Since the first quantity level is 20, we need to translate the model by subtracting $x$ by $Q_0 - 1 = 19$. This gives the following model $$C_{T}(Q) = \frac{\beta_0 - \beta_1}{Q - Q_0 - 1} + \beta_1$$ if $Q > 1$. However, the model still underfits the data because the cost decreases much slower than the model used for our previous tests. Therefore, we can assume that a model can be used to estimate the cost by one or many suppliers but not all.


# 4 Decision Tree(s)
In this section, we will identify conditional paths which will tell us if decision trees will be useful or not. We will answer the question: _Are there decisions to take? If yes, what decisions?_ In the previous section, we have seen that the model can underfit if there are not enough quantity purchase levels and if the quantity is small. Otherwise, we can use the model to estimate the cost given a quantity and a tube assembly. Here are few points that identify some conditions.

* If there is only one quantity purchase level, we cannot estimate the cost. We need al least another feature on which the cost depends.
* If there are many quantity purchase levels but with $Q_0 > 1$, then we need to translate the model found at section 3.
* If the quantities are too low, then the model underfits. Thus, we need to add other cost-dependent features.
* Depending of the supplier, the model may be different. Since we have 57 suppliers in the train set, we can have at most 57 possible models.

Only with those conditions, we can build many decision trees to help us to estimate the cost.


# 5 Machine Learning Algorithms and Results
In this section, we present the machine learning algorithms we will try after the analysis given by the four previous sections. Per the section 4 (Decisions), we have seen that many decision trees can be built. This leaves us two possible algorithms: Random Forest or Boosting Trees for Regression (XGBoost).

### 5.1 Random Forest Algorithm

```{r echo = FALSE, message = FALSE, warning = FALSE}
set.seed(415)
library(lubridate)


## Load the train set and convert features.
train_data <- read.csv("Dataset/train_set.csv")
train_data$id <- 1:nrow(train_data)
train_data$supplier <- as.numeric(substring(train_data$supplier, 3))
train_data$tube_assembly_id <- as.numeric(substring(train_data$tube_assembly_id, 4))
date <- ymd(as.character(train_data$quote_date))
days <- yday(date) - 1
train_data$quote_date <- cumsum(days) 

## Load the test set and convert features.
test_data <- read.csv("Dataset/test_set.csv")
test_data$supplier <- as.numeric(substring(test_data$supplier, 3))
test_data$tube_assembly_id <- as.numeric(substring(test_data$tube_assembly_id, 4))
date <- ymd(as.character(test_data$quote_date))
days <- yday(date) - 1
test_data$quote_date <- cumsum(days)

## Model Prediction with Random Forest.
tube.rf <- randomForest(log(cost + 1) ~., data = train_data, nTree = 50, importance = TRUE, do.trace = 2)
prediction <- exp(predict(tube.rf, newdata = test_data)) - 1
predict_rf_data <- cbind(test_data$tube_assembly_id, test_data$supplier, test_data$quantity, prediction)
colnames(predict_rf_data) <- c('tube_assembly_id', 'Supplier ID', 'quantity', 'cost')
write.csv(predict_rf_data, "Predict_RF.csv", row.names = FALSE)
```